<html>
  <head>
    <title>Manipulating Data with SQL</title>
    <link href="../../../../static/favicon.png" rel="icon" />
    <link href="../../../../static/favicon.png" rel="shortcut icon" />
    <link media="all" type="text/css" href="../../../../static/clojure.css" rel="stylesheet" />
    <link media="all" type="text/css" href="../../../../static/wiki.css" rel="stylesheet" />
    <link media="all" type="text/css" href="../../../../static/internal.css" rel="stylesheet" />
    <style>.menuWrapper{height: 36px;}</style>
    <!--[if lte IE 6]>
    <link rel="stylesheet" href="http://www.wikispaces.com/_/2009051601/s/internal_ie.css" type="text/css" />
    <![endif]-->
  </head>
<!--
This document was auto-generated from the source by the clojure autodoc system.
To report errors or ask questions about the overall documentation structure, formatting,
etc., contact Tom Faulhaber (google mail name: tomfaulhaber).
For errors in the documentation of a particular namespace, contact the author of that
namespace.
-->
  <body>
    <div id="AllContentContainer">
      <div id="Header">
	<a id="Logo" href="index.html"><img alt="Clojure" height="100" width="100" src="../../../../static/clojure-icon.gif" /></a>
	<h1><a title="page header title" id="page-header" href="index.html">JDBC-based SQL Interface</a></h1>
      </div>
      <div id="leftcolumn"><div style="text-align: center;"></div>
<div class="menu">
  <div class="WikiCustomNav WikiElement wiki">
    <span class="toc-header"><span id="project-name">JDBC-based SQL Interface</span> <span id="version">0.0.1</span> API</span><br />
    <ul>
      <li><a class="wiki_link" href="../../../../index.html">Overview</a></li>
      <li><a class="wiki_link" href="../../../../api-index.html">API Index</a></li>
    </ul>
    
    
    <a href="../../../../http://clojure.org" class="wiki_link">Clojure Home</a>
  </div>
</div>
</div>
      <div id="rightcolumn">
	<div id="Content">
	  <div class="contentBox"><div class="innerContentBox">
              <div id="content_view" class="wiki wikiPage">
                <div id="right-sidebar"></div>
                <div id="content-tag"><html><body><h1>Manipulating Data with SQL</h1>

<p>Here are some examples of using clojure.java.jdbc to manipulate data with SQL.
These examples assume a simple table called fruit (see <a href="https://github.com/clojure/java.jdbc/blob/master/doc/clojure/java/jdbc/UsingDDL.md">Manipulating Tables with DDL</a>).</p>

<h2>Inserting multiple rows</h2>

<p>If you want to insert complete rows, you can use <em>insert-rows</em> and provide the values as a simple vector for each row. Every column's value must be present in the same order the columns are declared in the table. This performs a single insert statement. If you attempt to insert a single row, a map of the generated keys will be returned.</p>

<p><code>clj
(defn insert-rows-fruit
  "Insert complete rows"
  []
  (sql/insert-rows
    :fruit
    ["Apple" "red" 59 87]
    ["Banana" "yellow" 29 92.2]
    ["Peach" "fuzzy" 139 90.0]
    ["Orange" "juicy" 89 88.6]))
</code></p>

<h2>Inserting partial rows</h2>

<p>If you want to insert rows but only specify some columns' values, you can use <em>insert-values</em> and provide the names of the columns following by vectors containing values for those columns. This performs a single insert statement. If you attempt to insert a single row, a map of the generated keys will be returned.</p>

<p><code>clj
(defn insert-values-fruit
  "Insert rows with values for only specific columns"
  []
  (sql/insert-values
    :fruit
    [:name :cost]
    ["Mango" 722]
    ["Feijoa" 441]))
</code></p>

<h2>Inserting a record</h2>

<p>If you want to insert a single record, you can use <em>insert-record</em> and specify the columns and their values as a map. This performs a single insert statement. A map of the generated keys will be returned.</p>

<p><code>clj
(defn insert-record-fruit
  "Insert a single record, map from keys specifying columsn to values"
  []
  (sql/insert-record
    :fruit
    {:name "Pear" :appearance "green" :cost 99}))
</code></p>

<h2>Inserting multiple records</h2>

<p>If you want to insert multiple records, you can use <em>insert-records</em> and specify each record as a map of columns and their values. This performs a separate insert statement for each record. The generated keys are returned in a sequence of maps.</p>

<p><code>clj
(defn insert-records-fruit
  "Insert records, maps from keys specifying columns to values"
  []
  (sql/insert-records
    :fruit
    {:name "Pomegranate" :appearance "fresh" :cost 585}
    {:name "Kiwifruit" :grade 93}))
</code></p>

<h2>Using transactions</h2>

<p>You can write multiple operations in a transaction to ensure they are either all performed, or all rolled back.</p>

<p><code>clj
(defn db-write
  "Write initial values to the database as a transaction"
  []
  (sql/with-connection db
    (sql/transaction
     (drop-fruit)
     (create-fruit)
     (insert-rows-fruit)
     (insert-values-fruit)
     (insert-records-fruit)))
  nil)
</code></p>

<h2>Reading and processing rows</h2>

<p>To execute code against each row in a result set, use <em>with-query-results</em> with SQL.</p>

<p>```clj
(defn db-read
  "Read the entire fruit table"
  []
  (sql/with-connection db
    (sql/with-query-results res
      ["SELECT * FROM fruit"]
      (doseq [rec res]
        (println rec)))))</p>

<p>(defn db-read-all
  "Return all the rows of the fruit table as a vector"
  []
  (sql/with-connection db
    (sql/with-query-results res
      ["SELECT * FROM fruit"]
      (into [] res))))</p>

<p>(defn db-grade-range
  "Print rows describing fruit that are within a grade range"
  [min max]
  (sql/with-connection db
    (sql/with-query-results res
      [(str "SELECT name, cost, grade "
            "FROM fruit "
            "WHERE grade &gt;= ? AND grade &lt;= ?")
       min max]
      (doseq [rec res]
        (println rec)))))</p>

<p>(defn db-grade-a 
  "Print rows describing all grade a fruit (grade between 90 and 100)"
  []
  (db-grade-range 90 100))
```</p>

<h2>Updating values across a table</h2>

<p>To update column values based on a SQL predicate, use <em>update-values</em> with a SQL where clause and a map of columns to new values. The result is a sequence of update counts, indicating the number of records affected by each update (in this case, a single update and therefore a single count in the sequence).</p>

<p>```clj
(defn db-update-appearance-cost
  "Update the appearance and cost of the named fruit"
  [name appearance cost]
  (sql/update-values
   :fruit
   ["name=?" name]
   {:appearance appearance :cost cost}))</p>

<p>(defn db-update
  "Update two fruits as a transaction"
  []
  (sql/with-connection db
    (sql/transaction
     (db-update-appearance-cost "Banana" "bruised" 14)
     (db-update-appearance-cost "Feijoa" "green" 400)))
  nil)
```</p>

<h2>Updating values or Inserting records conditionally</h2>

<p>If you want to update existing records that match a SQL predicate or insert a new record if no existing records match, use <em>update-or-insert-values</em> with a SQL where clause and a map of columns to values. This calls <em>update-values</em> first and if no rows were updated, this calls <em>insert-values</em>. The result is either the sequence of update counts from the update or the sequence of generated key maps from the insert.</p>

<p><code>clj
(defn db-update-or-insert
  "Updates or inserts a fruit"
  [record]
  (sql/with-connection db
    (sql/update-or-insert-values
     :fruit
     ["name=?" (:name record)]
     record)))
</code></p>

<h2>Exception Handling and Transaction Rollback</h2>

<p>Transactions are rolled back if an exception is thrown, as shown in these examples.</p>

<p>```clj
(defn db-exception
  "Demonstrate rolling back a partially completed transaction on exception"
  []
  (sql/with-connection db
    (sql/transaction
     (sql/insert-values
      :fruit
      [:name :appearance]
      ["Grape" "yummy"]
      ["Pear" "bruised"])
     ;; at this point the insert-values call is complete, but the transaction
     ;; is not. the exception will cause it to roll back leaving the database
     ;; untouched.
     (throw (Exception. "sql/test exception")))))</p>

<p>(defn db-sql-exception
  "Demonstrate an sql exception"
  []
  (sql/with-connection db
    (sql/transaction
     (sql/insert-values
      :fruit
      [:name :appearance]
      ["Grape" "yummy"]
      ["Pear" "bruised"]
      ["Apple" "strange" "whoops"]))))</p>

<p>(defn db-batchupdate-exception
  "Demonstrate a batch update exception"
  []
  (sql/with-connection db
    (sql/transaction
     (sql/do-commands
      "DROP TABLE fruit"
      "DROP TABLE fruit"))))</p>

<p>(defn db-rollback
  "Demonstrate a rollback-only trasaction"
  []
  (sql/with-connection db
    (sql/transaction
     (prn "is-rollback-only" (sql/is-rollback-only))
     (sql/set-rollback-only)
     (sql/insert-values
      :fruit
      [:name :appearance]
      ["Grape" "yummy"]
      ["Pear" "bruised"])
     (prn "is-rollback-only" (sql/is-rollback-only))
     (sql/with-query-results res
       ["SELECT * FROM fruit"]
       (doseq [rec res]
         (println rec))))
    (prn)
    (sql/with-query-results res
      ["SELECT * FROM fruit"]
      (doseq [rec res]
        (println rec)))))
```</p>
</body></html></div>
              </div>
            </div>
          </div>
	</div>
	<div id="foot">
	  <div style="text-align: center;" id="copyright">No copyright info </div>
	</div>
      </div>
      <div id="DesignedBy">Logo &amp; site design by <a title="Visit Tom Hickey's website." href="http://www.tomhickey.com">Tom Hickey</a>.<br />
      Clojure auto-documentation system by Tom Faulhaber.</div>
    </div>
    <!-- /AllContentContainer -->
  </body>

</html>